name: Build APK (Flet)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

# ğŸ”§ CONFIGURACIÃ“N DE LA APP - MODIFICA AQUÃ
env:
  # ğŸ“± INFORMACIÃ“N DE LA APP - CAMBIA ESTOS VALORES
  APP_NAME: "MiAppFlet"                    # â† CAMBIA EL NOMBRE DE LA APP AQUÃ (sin espacios)
  APP_DISPLAY_NAME: "Mi AplicaciÃ³n Flet"   # â† NOMBRE MOSTRADO AL USUARIO
  APP_DESCRIPTION: "Mi aplicaciÃ³n creada con Flet"  # â† DESCRIPCIÃ“N DE LA APP
  PACKAGE_NAME: "com.miempresa.miapp"      # â† CAMBIA EL PACKAGE NAME (formato: com.empresa.app)
  
  # ğŸ“‹ VERSIONES
  BUILD_NUMBER: 1
  BUILD_VERSION: "1.0.0"
  
  # ğŸ› ï¸ VERSIONES DE HERRAMIENTAS
  PYTHON_VERSION: "3.12.2"
  FLUTTER_VERSION: "3.22.2"

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: â˜• Set up Java (JDK 21)
        uses: actions/setup-java@v4.2.1
        with:
          distribution: 'temurin'
          java-version: '21'
          
      - name: ğŸ”· Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: ğŸš« Disable Flutter analytics
        run: flutter config --no-analytics
        
      # ğŸ¨ CONFIGURACIÃ“N DE ICONOS - DESCOMENTA ESTA SECCIÃ“N SI TIENES ICONO PERSONALIZADO
      # - name: ğŸ¨ Setup App Icon
      #   run: |
      #     echo "Configurando icono personalizado..."
      #     # Verifica si existe el icono
      #     if [ -f "assets/icon.png" ]; then
      #       echo "âœ… Icono encontrado: assets/icon.png"
      #       mkdir -p build/assets
      #       cp assets/icon.png build/assets/icon.png
      #     else
      #       echo "âš ï¸ No se encontrÃ³ assets/icon.png - usando icono por defecto"
      #     fi
        
      - name: ğŸ”§ Build APK with Flet
        run: |
          echo "ğŸš€ Construyendo APK para: ${{ env.APP_DISPLAY_NAME }}"
          flet build apk \
            --verbose \
            --build-number=${{ env.BUILD_NUMBER }} \
            --build-version=${{ env.BUILD_VERSION }} \
            --flutter-build-args="--release --target-platform=android-arm64" \
            --no-rich-output \
            --project="${{ env.APP_NAME }}" \
            --description="${{ env.APP_DESCRIPTION }}" \
            --org="${{ env.PACKAGE_NAME }}"
            # --icon="assets/icon.png"  # â† DESCOMENTA SI TIENES ICONO PERSONALIZADO
        env:
          FLUTTER_BUILD_MODE: release
          
      - name: ğŸ“‚ List build artifacts
        run: |
          echo "=== ğŸ” Buscando archivos APK generados ==="
          find . -name "*.apk" -type f -exec ls -lh {} \;
          echo ""
          echo "=== ğŸ“ Contenido del directorio build ==="
          if [ -d "build" ]; then
            find build -type f -name "*.apk" -exec ls -lh {} \;
          else
            echo "âŒ No se encontrÃ³ directorio build"
          fi
          
      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: ${{ env.APP_NAME }}-v${{ env.BUILD_VERSION }}-build${{ env.BUILD_NUMBER }}
          path: |
            build/apk/**/*.apk
            build/**/*app-release.apk
            build/**/*.apk
          retention-days: 30
          
      - name: âœ… Build Summary
        run: |
          echo "ğŸ‰ Â¡Build completado exitosamente!"
          echo ""
          echo "ğŸ“± App: ${{ env.APP_DISPLAY_NAME }}"
          echo "ğŸ“¦ Package: ${{ env.PACKAGE_NAME }}"
          echo "ğŸ·ï¸ VersiÃ³n: ${{ env.BUILD_VERSION }} (Build ${{ env.BUILD_NUMBER }})"
          echo ""
          echo "ğŸ“¥ Para descargar el APK:"
          echo "1. Ve a la pestaÃ±a 'Actions' de tu repositorio"
          echo "2. Busca este workflow ejecutado"
          echo "3. Descarga el artifact: ${{ env.APP_NAME }}-v${{ env.BUILD_VERSION }}-build${{ env.BUILD_NUMBER }}"

# ğŸ“‹ INSTRUCCIONES DE CONFIGURACIÃ“N:
#
# ğŸ¯ PARA CAMBIAR EL NOMBRE DE LA APP:
# 1. Modifica APP_NAME (nombre tÃ©cnico, sin espacios ni caracteres especiales)
# 2. Modifica APP_DISPLAY_NAME (nombre que verÃ¡ el usuario en su dispositivo)
# 3. Modifica APP_DESCRIPTION (descripciÃ³n de la app)
# 4. Modifica PACKAGE_NAME (identificador Ãºnico, formato: com.empresa.nombreapp)
#
# ğŸ¨ PARA AGREGAR UN ICONO PERSONALIZADO:
# 1. Crea una carpeta "assets/" en la raÃ­z de tu proyecto
# 2. Coloca tu icono como "assets/icon.png" (tamaÃ±o recomendado: 512x512 pÃ­xeles)
# 3. DESCOMENTA la secciÃ³n "Setup App Icon" (lÃ­neas 46-55)
# 4. DESCOMENTA la lÃ­nea --icon="assets/icon.png" (lÃ­nea 71)
#
# ğŸ“ ESTRUCTURA DE ARCHIVOS NECESARIA:
# tu-proyecto/
# â”œâ”€â”€ main.py                    # Tu aplicaciÃ³n principal
# â”œâ”€â”€ requirements.txt           # Dependencias Python  
# â”œâ”€â”€ .github/workflows/         # Este archivo
# â”‚   â””â”€â”€ build.yml
# â””â”€â”€ assets/                   # (OPCIONAL - solo si quieres icono personalizado)
#     â””â”€â”€ icon.png              # Icono de la app (512x512px recomendado)
#
# ğŸ“‹ REQUIREMENTS.TXT MÃNIMO:
# flet>=0.21.0
# 
# ğŸš€ CÃ“MO USAR:
# 1. Modifica las variables de configuraciÃ³n arriba (APP_NAME, etc.)
# 2. Haz commit y push a tu repositorio
# 3. El APK se construirÃ¡ automÃ¡ticamente
# 4. DescÃ¡rgalo desde Actions â†’ Artifacts
#
# ğŸ’¡ TIPS:
# - APP_NAME: Solo letras, nÃºmeros y guiones (ej: "MiApp", "mi-app-genial")
# - PACKAGE_NAME: Debe ser Ãºnico (ej: "com.tuempresa.tuapp")
# - El icono debe ser PNG, preferiblemente 512x512 pÃ­xeles
# - Si no tienes icono, Flet usarÃ¡ uno por defecto
